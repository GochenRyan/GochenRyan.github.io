---
title: ã€æ¸¸æˆå®¢æˆ·ç«¯ã€‘åˆæ‰¹
id: 10
date: 2020-05-26 22:07:07
tags:
    - æ€§èƒ½ä¼˜åŒ–
    - æ¸¸æˆå®¢æˆ·ç«¯
categories: æ¸¸æˆå®¢æˆ·ç«¯
---

## å†™åœ¨å‰é¢

æœ€è¿‘å¿ƒåŠ›ç•¥æœ‰æ†”æ‚´ï¼Œæ„Ÿæƒ…æœªè¿›ï¼Œå®¶äº‹éš¾æ–­ã€‚ç½¢äº†ï¼Œå¦‚æ˜¯çŸ¥ï¼Œå¦‚æ˜¯è§ï¼Œå¦‚æ˜¯ä¿¡è§£ã€‚å†™ç‚¹æ–‡å­—æ”¾æ¾ä¸€ä¸‹ğŸ™ƒï¼Œè¿™ç¯‡æ–‡ç« æ¥è®²è®²**åˆæ‰¹**ã€‚  
**åˆæ‰¹**å¯¹äºæ¸¸æˆå®¢æˆ·ç«¯ç¨‹åºå·²ç»æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œè¿™é‡Œç®€è¦æ•´ç†ä¸€ä¸‹åˆæ‰¹çš„ä¸€äº›çŸ¥è¯†ã€‚é¦–å…ˆæˆ‘ä»¬æ¥èŠä¸€èŠ**Draw Call**...

<!-- more -->

## Draw Call
Draw Callæ˜¯ä»€ä¹ˆï¼ŸDraw Callå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼ŒCPUé€šè¿‡è°ƒç”¨è¿™ä¸ªå‘½ä»¤æ¥é€šçŸ¥GPUè¿›è¡Œæ¸²æŸ“ã€‚å¯¹äºOpenGLæ¥è¯´ï¼ŒDraw Callå°±æ˜¯glDrawArraysã€glDrawElementsç­‰å‡½æ•°çš„è°ƒç”¨ã€‚é‚£ä¹ˆï¼ŒDrawCallæ˜¯å¦‚ä½•å½±å“æ€§èƒ½çš„å‘¢ï¼Ÿä½œä¸ºæ‹·è´å¿è€…å¡å¡è¥¿ï¼Œè¿™é‡Œå¼•ç”¨[ä¸€æ»´è¡€çš„è®°å¿†çš„ä¸“æ æ–‡ç« ](https://zhuanlan.zhihu.com/p/68530142)  
> å½“æ¯æ¬¡è°ƒç”¨APIçš„æ—¶å€™ï¼ŒèƒŒåå…¶å®éƒ½éœ€è¦ç»å†è¿™ä¹ˆå‡ ä¸ªé˜¶æ®µï¼š**application->runtime->driver->gpu**ã€‚æ¯ä¸€æ­¥éƒ½å­˜åœ¨æ€§èƒ½æ¶ˆè€—ã€‚å‰ä¸‰æ­¥æ˜¯åœ¨CPUä¸­è¿›è¡Œçš„ï¼Œè€Œæœ€åä¸€æ­¥çš„gpuæ¶ˆè€—ä¸»è¦æ˜¯åœ¨vertex shaderã€fragment shaderã€framebufferä¸­çš„å„ç§æ“ä½œ(blendã€test)ã€‚

![DrawCall1](/img/Batching/Draw Call1.png)

> æ¯è°ƒç”¨1æ¬¡æ¸²æŸ“apiå¹¶ä¸æ˜¯ç›´æ¥ç»è¿‡ä»¥ä¸Šçš„æ‰€æœ‰ç»„ä»¶é€šçŸ¥gpuæ‰§è¡Œæˆ‘ä»¬çš„è°ƒç”¨ã€‚**runtime**ä¼šå°†apiè°ƒç”¨è½¬æ¢ä¸ºè®¾å¤‡æ— å…³çš„"å‘½ä»¤"(è¿™æ ·æ‰èƒ½ä¿è¯åœ¨ä»»ä½•è®¾å¤‡ç¡¬ä»¶ä¸Šå…¼å®¹ï¼Œå…¶å®ä¹Ÿå°±æ˜¯åšåˆ°å¯¹ä¸åŒçš„ç¡¬ä»¶æ¶æ„åšåˆ°é€æ˜)ï¼Œç„¶åå°†å‘½ä»¤ç¼“å­˜åˆ°**commandbuffer**ä¸­å»ã€‚è€Œå‘½ä»¤ä»runtimeåˆ°**driver**è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œcpuä¼šå‘ç”Ÿä»**ç”¨æˆ·æ¨¡å¼**åˆ°**å†…æ ¸æ¨¡å¼**çš„è½¬æ¢ã€‚è¿™ä¸ªæ“ä½œæ˜¯ä¸€ä»¶éå¸¸è€—æ—¶çš„å·¥ä½œã€‚æ‰€ä»¥è¯´å¦‚æœæ¯æ¬¡apiè°ƒç”¨éƒ½ç›´æ¥å‘é€å‘½ä»¤åˆ°driverï¼Œé‚£å°†æ˜¯éå¸¸å·¨å¤§çš„æ€§èƒ½æ¶ˆè€—ã€‚æ‰€ä»¥åœ¨ä¸æ˜¯å¿…é¡»è¦é©¬ä¸Šæäº¤ç»™GPUç»˜åˆ¶çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç¼“å­˜åœ¨commandbufferä¸­ï¼Œç­‰åˆ°éœ€è¦æ—¶ä¸€æ¬¡æ€§æäº¤ï¼Œä¼˜åŒ–æ•ˆç‡ã€‚

![DrawCall2](/img/Batching/Draw Call2.png)

> å½“ç„¶è¿™é‡Œè¾¹è¿˜æ¶‰åŠåˆ°**æ¸²æŸ“çŠ¶æ€**(textureã€shaderã€materialå„ç§å‚æ•°)çš„å½±å“ï¼Œå¦‚æœæ¸²æŸ“çŠ¶æ€æ”¹å˜äº†ï¼Œé‚£ä¹ˆè¦ä½¿ç”¨ä¹‹å‰æ¸²æŸ“çŠ¶æ€è¿›è¡Œæ¸²æŸ“çš„æ‰€æœ‰drawcallå‘½ä»¤å¿…é¡»å…¨éƒ¨è¢«æ‰§è¡Œäº†ã€‚ä¹Ÿå°±æ˜¯è¯´ä¹‹å‰ç¼“å†²åœ¨commandbufferä¸­çš„æ‰€æœ‰drawcallå‘½ä»¤å¿…é¡»åˆ·æ–°ã€‚è¿™å…¶å®ä¼šå‘ç”Ÿä¸€æ¬¡ä»**ç”¨æˆ·æ¨¡å¼**åˆ°**å†…æ ¸æ¨¡å¼**çš„åˆ‡æ¢ã€‚
> ä»ä»¥ä¸Šä¸¤ç‚¹æ¥çœ‹æ¯æ¬¡æ¸²æŸ“çŠ¶æ€çš„æ”¹å˜å¯¼è‡´cpuæ¶ˆè€—å¢åŠ å…¶å®åŒ…å«ç€ä¸¤ä¸ªæ–¹é¢çš„æ€§èƒ½æ¶ˆè€—ï¼š
> 1. runtimeéœ€è¦å°†apiè½¬æ¢æˆè®¾å¤‡æ— å…³çš„"å‘½ä»¤"çš„æ—¶é—´æ¶ˆè€—;
> 2. çŠ¶æ€åˆ‡æ¢å¯¼è‡´çš„ä»ç”¨æˆ·æ¨¡å¼åˆ°å†…æ ¸æ¨¡å¼çš„æ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—ã€‚
> åŒæ ·çš„å¯¹äºä¼˜åŒ–batchï¼Œå‡å°‘drawcallä¹Ÿæœ‰ä¸¤æ¡è·¯å¯èµ°ï¼š
> 1. å¯¹driverè¿›è¡Œä¼˜åŒ–ï¼Œä½¿å…¶åœ¨è½¬æ¢ä¸Šé™ä½å¼€é”€ã€‚ç›®å‰çš„æœ€æ–°apiæ¥å£ï¼Œæ¯”å¦‚vulkanï¼Œmetalå…¶å®åœ¨è¿™æ–¹é¢å·²ç»åšäº†å¾ˆå¤§çš„æ”¹è¿›ï¼Œå¤§å¤§é™ä½äº†æ¨¡å¼è½¬æ¢ä¸Šçš„å¼€é”€ã€‚
> 2. é€šè¿‡åˆæ‰¹é™ä½drawcallï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å”¯ä¸€èƒ½åšçš„æ‰‹æ®µã€‚

Draw Callæ¶ˆè€—å¾ˆå°‘ï¼Œæ¸²æŸ“çŠ¶æ€æ”¹å˜æ¶ˆè€—å¤§ï¼Œæ¯•ç«ŸçŠ¶æ€æ”¹å˜çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿç”¨æˆ·æ¨¡å¼åˆ°å†…æ ¸æ¨¡å¼çš„è½¬æ¢ã€‚ä¸€èˆ¬æƒ…å†µä¸‹Draw Callæ•°é‡ç­‰äºæ¸²æŸ“çŠ¶æ€æ¬¡æ•°ï¼Œæ‰€ä»¥**åˆæ‰¹**ï¼ˆ**Draw Call Batching**ï¼‰çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚

## cocos2dxä¸­çš„åˆæ‰¹
### Auto Batching
cocos2dx 3.0æä¾›äº†ä¸€ç§å«åš**è‡ªåŠ¨æ‰¹ç»˜åˆ¶**ï¼ˆ**Auto Batching**)çš„æŠ€æœ¯ï¼Œå¯¹å¤šä¸ªç›¸é‚»çš„**RenderCommand**ï¼Œå¦‚æœå®ƒä»¬ä½¿ç”¨ç›¸åŒçš„**çº¹ç†**ã€ç›¸åŒçš„**blendfuncè®¾ç½®**ã€ç›¸åŒçš„**Shaderç¨‹åº**ï¼Œåˆ™åªä¼šè°ƒç”¨ä¸€æ¬¡OpenGL ESç»˜åˆ¶å‘½ä»¤ã€‚  
åœ¨ä¸»çº¿ç¨‹éå†å®Œ**UIæ ‘**ï¼Œå¹¶å°†æ¯ä¸ªUIå…ƒç´ çš„ç»˜åˆ¶å‘é€åˆ°**ç»˜åˆ¶æ ˆ**ä¸Šï¼Œç»˜åˆ¶çº¿ç¨‹å¼€å§‹æ‰§è¡Œå…¨éƒ¨ç»˜åˆ¶å‘½ä»¤ã€‚æ­¤æ—¶ï¼ŒRendereréœ€ç°å¯¹RenderCommandè¿›è¡Œæ’åºï¼Œç„¶åå†æŒ‰ç…§æ’åºåçš„é¡ºåºåˆ†åˆ«æ‰§è¡Œç»˜åˆ¶å‘½ä»¤ã€‚
* å½“ç¬¬ä¸€æ¬¡é‡åˆ°ç¬¬ä¸€ä¸ªQuadCommandæ—¶ä¸ä¼šç«‹å³ç»˜åˆ¶ï¼Œè€Œæ˜¯å°†å®ƒæ”¾å…¥ä¸€ä¸ªæ•°ç»„ä¸­ç¼“å­˜èµ·æ¥ï¼Œç„¶åç»§ç»­è¿­ä»£åé¢çš„RenderCommand;
* å¦‚æœä¹‹åé‡åˆ°çš„è¿˜æ˜¯QuadCommandï¼Œå¹¶ä¸”å®ƒä»¬æœ‰ç›¸åŒçš„**materialID**(é€šè¿‡å¯¹ç€è‰²å™¨åç§°ã€çº¹ç†åç§°ã€æ··åˆæ–¹ç¨‹ç­‰ç›¸å…³å‚æ•°è¿›è¡ŒHashè®¡ç®—)ï¼Œåˆ™ç»§ç»­æ·»åŠ åˆ°ç¼“å­˜æ•°ç»„ï¼›
* å¦‚æœé‡åˆ°çš„RenderCommandç±»å‹ä¸æ˜¯QUAD_COMMANDæˆ–è€…materialIDä¸åŒï¼Œåˆ™å…ˆç»˜åˆ¶ä¹‹å‰ç¼“å­˜çš„QuadCommandæ•°ç»„ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€æœ‰é¡¶ç‚¹æ•°ç»„ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªVBOå¯¹è±¡ï¼Œå®ƒèƒ½å®¹çº³çš„æœ€å¤§Quadæ•°é‡æ˜¯**10922**(65536/6)ã€‚æ‰€ä»¥ï¼Œå½“Quadçš„æ•°é‡å¤§äºè¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œå°†ä¼šç«‹å³æ‰§è¡Œå‰é¢çš„å‘½ä»¤ã€‚

### SpriteBatchNode
SpriteBatchNodeæ¯”è¾ƒå¤è€ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¦ç»˜åˆ¶çš„Spriteæ·»åŠ åˆ°ä¸€ä¸ªSpriteBatchNodeä¸‹ï¼Œå¼•æ“ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®ç°æ‰¹ç»˜åˆ¶ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„ç²¾çµéƒ½åº”è¯¥ä½¿ç”¨Spriteçš„è‡ªåŠ¨æ‰¹ç»˜åˆ¶ã€‚
### åˆå¹¶ä¸å‰”é™¤
å¯¹äºä¸€äº›å¯ä»¥æ‰¹æ¸²æŸ“çš„å¯¹è±¡ï¼Œä¼šå› ä¸ºä¸­é—´æ’å…¥äº†å…¶å®ƒå¯¹è±¡çš„æ¸²æŸ“è€Œæ‰“æ–­æ‰¹æ¸²æŸ“ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª**ç”»å¸ƒå¯¹è±¡**ï¼ˆGoogleä¸åˆ°ï¼Œåº”è¯¥æ˜¯å†…éƒ¨å¼•æ“åšäº†æ‰©å±•ï¼‰å°†å¯¹è±¡çš„æ¸²æŸ“é€»è¾‘æŠ½ç¦»å‡ºæ¥ç”±ç”»å¸ƒç®¡ç†ï¼Œé¿å…æ‰“æ–­æ‰¹æ¸²æŸ“ï¼Œä»è€Œå‡å°‘Draw Callã€‚  
è¿™é‡Œæœ‰ä¸¤ç§ç­–ç•¥ã€‚ä¸€ç§æ˜¯**åˆå¹¶**ï¼Œå°†éœ€è¦æ‰¹æ¸²æŸ“çš„å¯¹è±¡çš„æ¸²æŸ“é€»è¾‘æŠ½ç¦»å‡ºæ¥ï¼›å¦ä¸€ç§æ˜¯**å‰”é™¤**ï¼Œå°†æ‰“æ–­æ‰¹æ¸²æŸ“çš„å¯¹è±¡çš„æ¸²æŸ“é€»è¾‘æŠ½ç¦»å‡ºæ¥ã€‚
## Unityä¸­çš„åˆæ‰¹
Unityæä¾›äº†ä¸‰ç§æ‰¹æ¬¡åˆå¹¶çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯**Static Batching**ï¼Œ**GPU Instancing**å’Œ**Dynamic Batching**ï¼ˆç®€è¦ä»‹ç»ä¸€ä¸‹ï¼Œä¹‹åè¡¥å‘ï¼‰
### Static Batching
Static Batchingï¼Œå°†é™æ€ç‰©ä½“é›†åˆæˆä¸€ä¸ªå¤§å·vboæäº¤ï¼Œä½†æ˜¯åªå¯¹è¦æ¸²æŸ“çš„ç‰©ä½“æäº¤å…¶IBOã€‚
### Dynamic Batching
Dynamic Batchingï¼Œå°†ç‰©ä½“åŠ¨æ€ç»„è£…æˆä¸€ä¸ªä¸ªç¨å¤§çš„vbo+iboæäº¤ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸è¦æ±‚ä½¿ç”¨åŒæ ·çš„meshï¼Œä½†æ˜¯ä¹Ÿä¸€æ ·è¦æ±‚åŒæ ·çš„æè´¨ã€‚
### GPU Instancing
GPU Instancingï¼Œåªæäº¤ä¸€ä¸ªç‰©ä½“çš„meshï¼Œä½†æ˜¯å°†å¤šä¸ªä½¿ç”¨åŒç§meshå’Œmaterialçš„ç‰©ä½“çš„å·®å¼‚åŒ–ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä½ç½®ï¼Œç¼©æ”¾ï¼Œæ—‹è½¬ï¼Œshaderå‚æ•°ç­‰ï¼ˆshaderå‚æ•°ä¸åŒ…æ‹¬çº¹ç†ï¼‰ï¼‰ç»„åˆæˆä¸€ä¸ªPIOæäº¤ã€‚åœ¨GPUä¾§ï¼Œé€šè¿‡è¯»å–æ¯ä¸ªç‰©ä½“çš„PIOæ•°æ®ï¼Œå¯¹åŒä¸€ä¸ªmeshè¿›è¡Œå„ç§å˜æ¢åç»˜åˆ¶ã€‚
## åˆå›¾
åˆå›¾ï¼Œä¹Ÿå°±æ˜¯åˆæˆ**å›¾é›†**ï¼ˆTexture atlasï¼‰ã€‚å¼•ç”¨wikiä¸­çš„ç›¸å…³ä»‹ç»:

> In [computer graphics](https://en.wikipedia.org/wiki/Computer_graphics "Computer graphics"), a **texture atlas** (also called a **sprite sheet** or an **image sprite**) is an image containing multiple smaller images, usually packed together to reduce overall dimensions.[[1]](https://en.wikipedia.org/wiki/Texture_atlas#cite_note-nvidia-1) An atlas can consist of uniformly-sized images or images of varying dimensions.[[1]](https://en.wikipedia.org/wiki/Texture_atlas#cite_note-nvidia-1) A sub-image is drawn using custom [texture coordinates](https://en.wikipedia.org/wiki/Texture_coordinates "Texture coordinates") to pick it out of the atlas.

![Tile_set](/img/Batching/Tile_set.png)

ç®€å•æ¥è¯´ï¼Œå›¾é›†æ˜¯åŒ…å«è®¸å¤šå°å›¾çš„ä¸€å¼ å¤§å›¾ï¼Œå®ƒä¼šè¢«GPUè§†ä¸ºä¸€ä¸ªå•å…ƒã€‚è¿™æ ·ï¼Œé€šè¿‡å¢åŠ å†…å­˜ä½ç½®åï¼Œå¯ä»¥å‡å°‘æ¸²æŸ“çŠ¶æ€åˆ‡æ¢çš„å¼€é”€ã€‚åˆå›¾åï¼ŒCPUåœ¨ä¼ é€èµ„æºä¿¡æ¯ç»™GPUæ—¶ï¼Œåªéœ€è¦ä¼ è¿™å¼ å¤§å›¾å°±å¯ä»¥äº†ï¼ŒGPUå¯ä»¥åœ¨è¿™å¼ å¤§å›¾ä¸­çš„ä¸åŒåŒºåŸŸè¿›è¡Œé‡‡æ ·ã€‚  
å½“ç„¶ï¼Œå›¾é›†å¤ªå¤§çš„è¯ï¼ŒåŠ è½½è¿™å¼ å¤§å›¾å°±ä¼šå‡ºç°é—®é¢˜ï¼Œè¿™å°±æ¶‰åŠåˆ°å›¾é›†çš„æ•´ç†ç­–ç•¥ã€‚ä¸åŒçš„é¡¹ç›®æœ‰ä¸åŒçš„ç­–ç•¥ï¼Œè¿™é‡Œä¸åšå±•å¼€ï¼Œè´´ä¸€ç¯‡çŸ¥ä¹ä¸“æ æ–‡ç« [ã€unityæ¸¸æˆå¼€å‘ã€‘å›¾é›†æ•´ç†ç­–ç•¥](https://zhuanlan.zhihu.com/p/90494264)ã€‚

